// Prisma schema for Inventario Ganaderia

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  VETERINARIO
  OPERADOR
  AUDITOR
}

enum AnimalSex {
  MALE
  FEMALE
}

enum AnimalCategory {
  TERNERO
  VAQUILLA
  VACA
  TORO
  TORILLO
}

enum AnimalStatus {
  ACTIVO
  VENDIDO
  MUERTO
  FAENADO
  PERDIDO
}

enum AnimalOrigin {
  BORN
  BOUGHT
}

enum EventType {
  PESO
  NACIMIENTO
  DESTETE
  CELO
  PRENEZ
  PARTO
  VACUNACION
  DESPARASITACION
  ENFERMEDAD
  MUERTE
  VENTA
  COMPRA
  OBSERVACION
}

enum MovementType {
  INTERNAL
  EXTERNAL
  SALE
  SLAUGHTER
}

enum EstablishmentType {
  FINCA
  POTRERO
  CORRAL
}

enum InventoryTxType {
  IN
  OUT
  ADJUST
}

enum TreatmentStatus {
  ACTIVE
  CLOSED
}

enum TaskStatus {
  OPEN
  DONE
}

enum AlertType {
  STOCK
  EXPIRY
  WITHDRAWAL
}

enum ProductType {
  VITAMINAS
  ANTIBIOTICOS
  DESPARASITANTE
  VACUNAS
}

enum MemberStatus {
  ACTIVE
  REVOKED
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  users     User[]
  members   OrganizationMember[]
  invites   OrganizationInvite[]
  establishments Establishment[]
  suppliers Supplier[]
  animals   Animal[]
  animalEvents AnimalEvent[]
  movements Movement[]
  products  Product[]
  batches   Batch[]
  inventoryTransactions InventoryTransaction[]
  treatments Treatment[]
  administrations Administration[]
  animalPhotos AnimalPhoto[]
  labResults LabResult[]
  auditLogs AuditLog[]
  alerts    Alert[]
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String         @id @default(uuid())
  organizationId String
  name         String
  email        String         @unique
  passwordHash String
  isActive     Boolean        @default(true)
  roles        UserRole[]
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[]
  memberships OrganizationMember[]
  invitesCreated OrganizationInvite[] @relation("InviteCreator")
  organization Organization @relation(fields: [organizationId], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([organizationId])
}

model OrganizationMember {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  status         MemberStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationInvite {
  id             String    @id @default(uuid())
  organizationId String
  email          String
  role           RoleName
  tokenHash      String
  expiresAt      DateTime
  acceptedAt     DateTime?
  revokedAt      DateTime?
  createdBy      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  creator      User?        @relation("InviteCreator", fields: [createdBy], references: [id])

  @@index([organizationId])
  @@index([email])
  @@index([expiresAt])
}

model Role {
  id          String     @id @default(uuid())
  name        RoleName   @unique
  description String
  users       UserRole[]
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  userAgent String?
  ip        String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Establishment {
  id        String   @id @default(uuid())
  name      String
  type      EstablishmentType
  organizationId String
  parentId  String?
  fincaId   String?
  animals   Animal[]
  events    AnimalEvent[]
  organization Organization @relation(fields: [organizationId], references: [id])
  parent    Establishment? @relation("EstablishmentHierarchy", fields: [parentId], references: [id])
  children  Establishment[] @relation("EstablishmentHierarchy")
  originMovements      Movement[] @relation("MovementOrigin")
  destinationMovements Movement[] @relation("MovementDestination")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([parentId])
  @@index([fincaId])
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  organizationId String
  contact   String?
  phone     String?
  email     String?
  animals   Animal[]
  batches   Batch[]
  organization Organization @relation(fields: [organizationId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

model Animal {
  id              String        @id @default(uuid())
  internalCode    String
  tag             String?
  organizationId  String
  sex             AnimalSex
  breed           String
  birthDate       DateTime?
  birthEstimated  Boolean       @default(false)
  category        AnimalCategory
  status          AnimalStatus  @default(ACTIVO)
  origin          AnimalOrigin
  supplierId      String?
  motherId        String?
  fatherId        String?
  establishmentId String?
  notes           String?
  photos          AnimalPhoto[]
  events          AnimalEvent[]
  movements       Movement[]
  treatments      Treatment[]
  labResults      LabResult[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  supplier      Supplier?     @relation(fields: [supplierId], references: [id])
  establishment Establishment? @relation(fields: [establishmentId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@unique([organizationId, internalCode])
  @@unique([organizationId, tag])
  @@index([establishmentId])
}

model AnimalPhoto {
  id        String   @id @default(uuid())
  animalId  String
  url       String
  organizationId String
  createdAt DateTime @default(now())

  animal Animal @relation(fields: [animalId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model AnimalEvent {
  id              String     @id @default(uuid())
  animalId        String
  organizationId  String
  type            EventType
  occurredAt      DateTime
  establishmentId String?
  valueNumber     Float?
  valueText       String?
  notes           String?
  createdBy       String?
  createdAt       DateTime   @default(now())

  animal        Animal        @relation(fields: [animalId], references: [id])
  establishment Establishment? @relation(fields: [establishmentId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([occurredAt])
}

model Movement {
  id             String        @id @default(uuid())
  animalId       String
  organizationId String
  occurredAt     DateTime
  originId       String?
  destinationId  String?
  movementType   MovementType
  transporter    String?
  notes          String?
  createdBy      String?
  createdAt      DateTime      @default(now())

  animal      Animal         @relation(fields: [animalId], references: [id])
  origin      Establishment? @relation("MovementOrigin", fields: [originId], references: [id])
  destination Establishment? @relation("MovementDestination", fields: [destinationId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([occurredAt])
  @@index([originId])
  @@index([destinationId])
}

model Product {
  id                   String   @id @default(uuid())
  name                 String
  organizationId       String
  type                 ProductType?
  vaccineTypes         String[] @default([])
  activeIngredient     String
  presentation         String
  concentration        String
  unit                 String
  species              String   @default("bovinos")
  meatWithdrawalDays   Int
  milkWithdrawalDays   Int
  requiresPrescription Boolean @default(false)
  recommendedRoute     String?
  typicalDose          String?
  notes                String?
  minStock             Int      @default(0)
  batches              Batch[]
  inventoryTransactions InventoryTransaction[]
  administrations      Administration[]
  organization Organization @relation(fields: [organizationId], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deletedAt            DateTime?

  @@index([organizationId])
  @@index([name])
}

model Batch {
  id                String   @id @default(uuid())
  productId         String
  organizationId    String
  batchNumber       String
  expiresAt         DateTime
  supplierId        String?
  receivedAt        DateTime
  cost              Decimal? @db.Decimal(10, 2)
  quantityInitial   Float
  quantityAvailable Float
  transactions      InventoryTransaction[]
  administrations   Administration[]
  organization Organization @relation(fields: [organizationId], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  product  Product  @relation(fields: [productId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([organizationId])
  @@index([expiresAt])
  @@unique([productId, batchNumber])
}

model InventoryTransaction {
  id         String           @id @default(uuid())
  batchId    String
  productId  String
  organizationId String
  type       InventoryTxType
  quantity   Float
  unit       String
  occurredAt DateTime
  reason     String?
  refType    String?
  refId      String?
  createdBy  String?
  createdAt  DateTime @default(now())

  batch   Batch   @relation(fields: [batchId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([occurredAt])
}

model Treatment {
  id         String         @id @default(uuid())
  animalId   String
  organizationId String
  diagnosis  String
  vetId      String?
  startedAt  DateTime
  endedAt    DateTime?
  status     TreatmentStatus @default(ACTIVE)
  notes      String?
  createdBy  String?
  createdAt  DateTime @default(now())

  animal Animal @relation(fields: [animalId], references: [id])
  administrations Administration[]
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([startedAt])
}

model Administration {
  id                  String   @id @default(uuid())
  treatmentId         String
  batchId             String
  productId           String
  organizationId      String
  administeredAt      DateTime
  dose                Float
  doseUnit            String
  route               String
  site                String?
  notes               String?
  meatWithdrawalUntil DateTime
  milkWithdrawalUntil DateTime
  createdBy           String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  treatment Treatment @relation(fields: [treatmentId], references: [id])
  batch     Batch     @relation(fields: [batchId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([administeredAt])
}

model LabResult {
  id          String   @id @default(uuid())
  animalId    String
  organizationId String
  name        String
  result      String
  collectedAt DateTime

  animal Animal @relation(fields: [animalId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  organizationId String
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ip        String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([createdAt])
}

model Alert {
  id        String    @id @default(uuid())
  type      AlertType
  organizationId String
  title     String
  message   String
  dueAt     DateTime
  status    TaskStatus @default(OPEN)
  createdAt DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Task {
  id        String    @id @default(uuid())
  title     String
  taskType  String
  organizationId String
  dueAt     DateTime
  status    TaskStatus @default(OPEN)
  notes     String?
  createdAt DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}
