// Prisma schema for Inventario Ganaderia

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  VETERINARIO
  OPERADOR
  AUDITOR
}

enum AnimalSex {
  MALE
  FEMALE
}

enum AnimalCategory {
  TERNERO
  VAQUILLA
  VACA
  TORO
  TORILLO
}

enum AnimalStatus {
  ACTIVO
  VENDIDO
  MUERTO
  FAENADO
  PERDIDO
}

enum AnimalOrigin {
  BORN
  BOUGHT
}

enum EventType {
  PESO
  NACIMIENTO
  DESTETE
  CELO
  PRENEZ
  PARTO
  VACUNACION
  DESPARASITACION
  ENFERMEDAD
  MUERTE
  VENTA
  COMPRA
  OBSERVACION
}

enum MovementType {
  INTERNAL
  EXTERNAL
  SALE
  SLAUGHTER
}

enum EstablishmentType {
  FINCA
  POTRERO
  CORRAL
}

enum InventoryTxType {
  IN
  OUT
  ADJUST
}

enum TreatmentStatus {
  ACTIVE
  CLOSED
}

enum TaskStatus {
  OPEN
  DONE
}

enum AlertType {
  STOCK
  EXPIRY
  WITHDRAWAL
}

enum ProductType {
  VITAMINAS
  ANTIBIOTICOS
  DESPARASITANTE
  VACUNAS
}

model User {
  id           String         @id @default(uuid())
  name         String
  email        String         @unique
  passwordHash String
  isActive     Boolean        @default(true)
  roles        UserRole[]
  createdTenants Tenant[] @relation("TenantCreatedBy")
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[]
  createdEstablishments Establishment[] @relation("EstablishmentCreatedBy")
  createdSuppliers Supplier[] @relation("SupplierCreatedBy")
  createdAnimals Animal[] @relation("AnimalCreatedBy")
  createdAnimalPhotos AnimalPhoto[] @relation("AnimalPhotoCreatedBy")
  createdAnimalEvents AnimalEvent[] @relation("AnimalEventCreatedBy")
  createdMovements Movement[] @relation("MovementCreatedBy")
  createdProducts Product[] @relation("ProductCreatedBy")
  createdBatches Batch[] @relation("BatchCreatedBy")
  createdInventoryTransactions InventoryTransaction[] @relation("InventoryTransactionCreatedBy")
  createdTreatments Treatment[] @relation("TreatmentCreatedBy")
  createdAdministrations Administration[] @relation("AdministrationCreatedBy")
  createdLabResults LabResult[] @relation("LabResultCreatedBy")
  createdAlerts Alert[] @relation("AlertCreatedBy")
  createdTasks Task[] @relation("TaskCreatedBy")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Role {
  id          String     @id @default(uuid())
  name        RoleName   @unique
  description String
  users       UserRole[]
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  createdById String?
  createdBy   User?    @relation("TenantCreatedBy", fields: [createdById], references: [id])
  users       UserRole[]
  establishments Establishment[]
  suppliers   Supplier[]
  animals     Animal[]
  animalPhotos AnimalPhoto[]
  events      AnimalEvent[]
  movements   Movement[]
  products    Product[]
  batches     Batch[]
  inventoryTransactions InventoryTransaction[]
  treatments  Treatment[]
  administrations Administration[]
  labResults  LabResult[]
  auditLogs   AuditLog[]
  alerts      Alert[]
  tasks       Task[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  tenantId  String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, roleId, tenantId])
  @@index([tenantId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  userAgent String?
  ip        String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Establishment {
  id        String   @id @default(uuid())
  name      String
  type      EstablishmentType
  parentId  String?
  fincaId   String?
  tenantId  String
  createdById String?
  animals   Animal[]
  events    AnimalEvent[]
  parent    Establishment? @relation("EstablishmentHierarchy", fields: [parentId], references: [id])
  children  Establishment[] @relation("EstablishmentHierarchy")
  originMovements      Movement[] @relation("MovementOrigin")
  destinationMovements Movement[] @relation("MovementDestination")
  createdBy User? @relation("EstablishmentCreatedBy", fields: [createdById], references: [id])
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([fincaId])
  @@index([createdById])
  @@index([tenantId])
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  phone     String?
  email     String?
  tenantId  String
  createdById String?
  animals   Animal[]
  batches   Batch[]
  createdBy User? @relation("SupplierCreatedBy", fields: [createdById], references: [id])
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([tenantId])
}

model Animal {
  id              String        @id @default(uuid())
  internalCode    String
  tag             String?
  sex             AnimalSex
  breed           String
  birthDate       DateTime?
  birthEstimated  Boolean       @default(false)
  category        AnimalCategory
  status          AnimalStatus  @default(ACTIVO)
  origin          AnimalOrigin
  supplierId      String?
  motherId        String?
  fatherId        String?
  establishmentId String?
  tenantId        String
  notes           String?
  createdById     String?
  photos          AnimalPhoto[]
  events          AnimalEvent[]
  movements       Movement[]
  treatments      Treatment[]
  labResults      LabResult[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  supplier      Supplier?     @relation(fields: [supplierId], references: [id])
  establishment Establishment? @relation(fields: [establishmentId], references: [id])
  createdBy     User? @relation("AnimalCreatedBy", fields: [createdById], references: [id])
  tenant        Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, internalCode])
  @@unique([tenantId, tag])
  @@index([tag])
  @@index([establishmentId])
  @@index([createdById])
  @@index([tenantId])
}

model AnimalPhoto {
  id        String   @id @default(uuid())
  animalId  String
  url       String
  tenantId  String
  createdById String?
  createdAt DateTime @default(now())

  animal Animal @relation(fields: [animalId], references: [id])
  createdBy User? @relation("AnimalPhotoCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([createdById])
  @@index([tenantId])
}

model AnimalEvent {
  id              String     @id @default(uuid())
  animalId        String
  type            EventType
  occurredAt      DateTime
  establishmentId String?
  tenantId        String
  valueNumber     Float?
  valueText       String?
  notes           String?
  createdById     String?
  createdAt       DateTime   @default(now())

  animal        Animal        @relation(fields: [animalId], references: [id])
  establishment Establishment? @relation(fields: [establishmentId], references: [id])
  createdBy     User? @relation("AnimalEventCreatedBy", fields: [createdById], references: [id])
  tenant        Tenant @relation(fields: [tenantId], references: [id])

  @@index([occurredAt])
  @@index([createdById])
  @@index([tenantId])
}

model Movement {
  id             String        @id @default(uuid())
  animalId       String
  occurredAt     DateTime
  originId       String?
  destinationId  String?
  movementType   MovementType
  transporter    String?
  notes          String?
  tenantId       String
  createdById    String?
  createdAt      DateTime      @default(now())

  animal      Animal         @relation(fields: [animalId], references: [id])
  origin      Establishment? @relation("MovementOrigin", fields: [originId], references: [id])
  destination Establishment? @relation("MovementDestination", fields: [destinationId], references: [id])
  createdBy   User? @relation("MovementCreatedBy", fields: [createdById], references: [id])
  tenant      Tenant @relation(fields: [tenantId], references: [id])

  @@index([occurredAt])
  @@index([originId])
  @@index([destinationId])
  @@index([createdById])
  @@index([tenantId])
}

model Product {
  id                   String   @id @default(uuid())
  name                 String
  type                 ProductType?
  vaccineTypes         String[] @default([])
  activeIngredient     String
  presentation         String
  concentration        String
  unit                 String
  species              String   @default("bovinos")
  meatWithdrawalDays   Int
  milkWithdrawalDays   Int
  requiresPrescription Boolean @default(false)
  recommendedRoute     String?
  typicalDose          String?
  notes                String?
  minStock             Int      @default(0)
  tenantId             String
  createdById          String?
  batches              Batch[]
  inventoryTransactions InventoryTransaction[]
  administrations      Administration[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deletedAt            DateTime?

  createdBy User? @relation("ProductCreatedBy", fields: [createdById], references: [id])
  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@index([name])
  @@index([createdById])
  @@index([tenantId])
}

model Batch {
  id                String   @id @default(uuid())
  productId         String
  batchNumber       String
  expiresAt         DateTime
  supplierId        String?
  receivedAt        DateTime
  cost              Decimal? @db.Decimal(10, 2)
  quantityInitial   Float
  quantityAvailable Float
  tenantId          String
  createdById       String?
  transactions      InventoryTransaction[]
  administrations   Administration[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  product  Product  @relation(fields: [productId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])
  createdBy User? @relation("BatchCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([expiresAt])
  @@unique([tenantId, productId, batchNumber])
  @@index([createdById])
  @@index([tenantId])
}

model InventoryTransaction {
  id         String           @id @default(uuid())
  batchId    String
  productId  String
  type       InventoryTxType
  quantity   Float
  unit       String
  occurredAt DateTime
  reason     String?
  refType    String?
  refId      String?
  tenantId   String
  createdById String?
  createdAt  DateTime @default(now())

  batch   Batch   @relation(fields: [batchId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  createdBy User? @relation("InventoryTransactionCreatedBy", fields: [createdById], references: [id])
  tenant  Tenant @relation(fields: [tenantId], references: [id])

  @@index([occurredAt])
  @@index([createdById])
  @@index([tenantId])
}

model Treatment {
  id         String         @id @default(uuid())
  animalId   String
  diagnosis  String
  vetId      String?
  startedAt  DateTime
  endedAt    DateTime?
  status     TreatmentStatus @default(ACTIVE)
  notes      String?
  tenantId   String
  createdById String?
  createdAt  DateTime @default(now())

  animal Animal @relation(fields: [animalId], references: [id])
  administrations Administration[]
  createdBy User? @relation("TreatmentCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([startedAt])
  @@index([createdById])
  @@index([tenantId])
}

model Administration {
  id                  String   @id @default(uuid())
  treatmentId         String
  batchId             String
  productId           String
  administeredAt      DateTime
  dose                Float
  doseUnit            String
  route               String
  site                String?
  notes               String?
  meatWithdrawalUntil DateTime
  milkWithdrawalUntil DateTime
  tenantId            String
  createdById         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  treatment Treatment @relation(fields: [treatmentId], references: [id])
  batch     Batch     @relation(fields: [batchId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])
  createdBy User? @relation("AdministrationCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([administeredAt])
  @@index([createdById])
  @@index([tenantId])
}

model LabResult {
  id          String   @id @default(uuid())
  animalId    String
  name        String
  result      String
  collectedAt DateTime
  tenantId    String
  createdById String?

  animal Animal @relation(fields: [animalId], references: [id])
  createdBy User? @relation("LabResultCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([createdById])
  @@index([tenantId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ip        String?
  tenantId  String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([createdAt])
  @@index([tenantId])
}

model Alert {
  id        String    @id @default(uuid())
  type      AlertType
  title     String
  message   String
  dueAt     DateTime
  status    TaskStatus @default(OPEN)
  tenantId  String
  createdById String?
  createdAt DateTime  @default(now())

  createdBy User? @relation("AlertCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([createdById])
  @@index([tenantId])
}

model Task {
  id        String    @id @default(uuid())
  title     String
  taskType  String
  dueAt     DateTime
  status    TaskStatus @default(OPEN)
  notes     String?
  tenantId  String
  createdById String?
  createdAt DateTime  @default(now())

  createdBy User? @relation("TaskCreatedBy", fields: [createdById], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@index([createdById])
  @@index([tenantId])
}
